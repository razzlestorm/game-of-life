
<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.8.9/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.8.9/brython_stdlib.js"></script>
    <title>Game of Life!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  </head>
  <body onload="brython(1)">
    <h1>File Upload</h1>
    <form method="POST" action="" enctype="multipart/form-data">
      <p><input type="file" name="file"></p>
      <p><input type="submit" value="Submit"></p>
    </form>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <!-- This dropdown is populated with all uploaded files -->
    <form method="POST" action="{{ url_for('game') }}">
      <select id="filedrop" name="filedrop" method="GET" action="/">
        {% for file in files %}
        <option value= {{url_for('upload', filename=file) }}>{{file}}</option>
        {% endfor %}
      </select>
      <button type="submit">Play with this board!</button>
    </form>
    <div id="image">
      <img id="selectedImage" style="width: 128px">
    </div>
    <!-- This changes the image src based on the value of the dropdown -->
    <script>    
      $( document ).ready(function() {
      document.getElementById("selectedImage").src=document.getElementById("filedrop").value;
      });
      $( "select" ) .change(function () {    
      document.getElementById("selectedImage").src=document.getElementById("filedrop").value;  
      });  
    </script>
    <hr>
    <div id ='gboard_div'>
      <img id='gboard' src={{ board }} style="display:none">
      <button id="next_button">Next</button>
    </div>

    <!-- <script>
      var canvas = document.getElementById('gamecanvas'),
      context = canvas.getContext('2d');

      make_base();

      function make_base()
      {
        base_image = new Image();
        base_image.src = document.getElementById("gboard").src;
        base_image.onload = function(){
    context.drawImage(base_image, 0, 0);
  }
      }
    </script> -->
<script type="text/python">
from browser import bind, document, html


img = document['gboard']
document <= "width: " + str(img.naturalWidth) + " height: " + str(img.naturalHeight)
img.naturalWidth = int(img.naturalWidth)
img.naturalHeight = int(img.naturalHeight)
canvas = html.CANVAS(width=img.naturalWidth, height=img.naturalHeight)
canvas.style = {"margin-left": "auto", "margin-right": "auto", "width": "50%"}
ctx = canvas.getContext('2d')
ctx.drawImage(img, 0, 0)
document <= canvas

boardImage = ctx.getImageData(0, 0, img.naturalWidth, img.naturalHeight)
document <= " board length: "  + str(len(boardImage.data)) + " "


def rule_checker(data, iterator, *args):
    count = 0
    for arg in args:
        if arg > 127:
            count += 1
    # check if cell is alive
    if data[iterator] > 127:
        if count in [2, 3]:
            # cell stays alive (255, 255, 255) = white
            data[iterator] = 255
            data[iterator+1] = 255
            data[iterator+2] = 255
        else:
            # cell dies
            data[iterator] = 0
            data[iterator+1] = 0
            data[iterator+2] = 0

    # check if cell is dead
    else:
        if count == 3:
            data[iterator] = 255
            data[iterator+1] = 255
            data[iterator+2] = 255
    return data

@bind("#next_button", "click")
def game(event):
    ii = 0
    while ii < len(boardImage.data):
        # NW Corner
        if ii == 0:
            E = boardImage.data[ii+4]
            S = boardImage.data[ii+(canvas.width*4)]
            SE = boardImage.data[ii+(canvas.width*4)+4]
            boardImage.data = rule_checker(boardImage.data, ii, E, S, SE)
        
        # NE Corner
        elif ii == (canvas.width*4)-4:
            W = boardImage.data[ii-4]
            SW = boardImage.data[ii+(canvas.width*4)-4]
            S = boardImage.data[ii+(canvas.width*4)]
            boardImage.data = rule_checker(boardImage.data, ii, W, SW, S)
        
        # SW Corner
        elif ii == (canvas.width*4)*(canvas.height-1):
            N = boardImage.data[ii-(canvas.width*4)]
            NE = boardImage.data[ii-(canvas.width*4)+4]
            E = boardImage.data[ii+4]
            boardImage.data = rule_checker(boardImage.data, ii, N, NE, E)
        
        # SE Corner
        elif ii == (canvas.width*4)*(canvas.height)-4:
            NW = boardImage.data[ii-(canvas.width*4)-4]
            N = boardImage.data[ii-(canvas.width*4)]
            W = boardImage.data[ii-4]
            boardImage.data = rule_checker(boardImage.data, ii, NW, N, W)

        # North Edge
        elif ii < (canvas.width*4)-4:
            E = boardImage.data[ii+4]
            W = boardImage.data[ii-4]
            SW = boardImage.data[ii+(canvas.width*4)-4]
            S = boardImage.data[ii+(canvas.width*4)]
            SE = boardImage.data[ii+(canvas.width*4)+4]
            boardImage.data = rule_checker(boardImage.data, ii, E, W, SW, S, SE)
        
                
        # South Edge
        elif (canvas.width*4)*(canvas.height-1) < ii < (canvas.width*4)*(canvas.height):
            NW = boardImage.data[ii-(canvas.width*4)-4]
            N = boardImage.data[ii-(canvas.width*4)]
            NE = boardImage.data[ii-(canvas.width*4)+4]
            W = boardImage.data[ii-4]
            E = boardImage.data[ii+4]
            boardImage.data = rule_checker(boardImage.data, ii, NW, N, NE, W, E)


        # West Edge
        elif ii % (canvas.width*4) == 0:
            N = boardImage.data[ii-(canvas.width*4)]
            NE = boardImage.data[ii-(canvas.width*4)+4]
            E = boardImage.data[ii+4]
            S = boardImage.data[ii+(canvas.width*4)]
            SE = boardImage.data[ii+(canvas.width*4)+4]
            boardImage.data = rule_checker(boardImage.data, ii, N, NE, E, S, SE)
        
        # East Edge
        elif ii % (canvas.width*4) == 396:
            NW = boardImage.data[ii-(canvas.width*4)-4]
            N = boardImage.data[ii-(canvas.width*4)]
            W = boardImage.data[ii-4]
            SW = boardImage.data[ii+(canvas.width*4)-4]
            try:
                S = boardImage.data[ii+(canvas.width*4)]
            except KeyError:
                S = boardImage.data[ii+(canvas.width*4)-1]
            boardImage.data = rule_checker(boardImage.data, ii, NW, N, W, SW, S)

        
        # Everywhere Else
        else:
            NW = boardImage.data[ii-(canvas.width*4)-4]
            N = boardImage.data[ii-(canvas.width*4)]
            NE = boardImage.data[ii-(canvas.width*4)+4]
            W = boardImage.data[ii-4]
            E = boardImage.data[ii+4]
            SW = boardImage.data[ii+(canvas.width*4)-4]
            S = boardImage.data[ii+(canvas.width*4)]
            try:
                SE = boardImage.data[ii+(canvas.width*4)+4]
            except KeyError:
                SE = boardImage.data[ii+(canvas.width*4)+3]
            boardImage.data = rule_checker(boardImage.data, ii, NW, N, NE, W, E, SW, S, SE)
        ii += 4
    ctx.putImageData(boardImage, 0, 0)
    document <= canvas


#step forward, then draw with html canvas, https://developer.mozilla.org/en-US/docs/Web/API/CanvasRenderingContext2D (maybe getImageData)
# https://stackoverflow.com/questions/51569444/check-cell-color-in-table-in-canvas
# https://stackoverflow.com/questions/12992681/html-5-canvas-get-color-of-an-image-and-then-change-the-pixels-with-that-color
</script>
  </body>
</html>