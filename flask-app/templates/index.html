
<!doctype html>
<html>
  <head>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.8.9/brython.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/brython@3.8.9/brython_stdlib.js"></script>
    <title>Game of Life!</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
  </head>
  <body onload="brython(1)">
    <h1>File Upload</h1>
    <form method="POST" action="{{ url_for('upload_files') }}" enctype="multipart/form-data">
      <p><input type="file" name="photo"></p>
      <p><input type="submit" value="Submit"></p>
    </form>
    <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <!-- This dropdown is populated with all uploaded files -->
    <form method="POST" action="{{ url_for('game') }}">
      <select id="filedrop" name="filedrop" method="GET" action="/">
        {% for image in images %}
        <option value="{{ img_path }}{{ image }}">{{ image }}</option>
        {% endfor %}
      </select>
      <button type="submit">Play with this board!</button>
    </form>
    <div id="image">
      <img id="selectedImage" src='{{ gameimg }}' style="width: 128px">
    </div>
    <hr>
    <div id ='gboard_div'>
      <img id='gboard' src='{{ gameimg }}' style="display:none">
      <button id="next_button">Next</button>
    </div>
    <!-- This changes the image src based on the value of the dropdown -->
    <script>    
      $( document ).ready(function() {
      document.getElementById("selectedImage").src=document.getElementById("filedrop").value;
      });
      $( "select" ) .change(function () {
      console.log(document.getElementById("filedrop").value);
      document.getElementById("selectedImage").src=document.getElementById("filedrop").value;  
      });  
    </script>

<script type="text/python">
from browser import bind, document, html
from browser.timer import request_animation_frame as raf
from browser.timer import cancel_animation_frame as caf


img = document['gboard']
document <= "width: " + str(img.naturalWidth) + " height: " + str(img.naturalHeight)
img.attrs['naturalWidth'] = int(img.naturalWidth)
img.attrs['naturalHeight'] = int(img.naturalHeight)
canvas = html.CANVAS(width=img.naturalWidth, height=img.naturalHeight)
canvas.style = {"margin-left": "auto", "margin-right": "auto", "width": "50%"}
ctx = canvas.getContext('2d')
ctx.imageSmoothingEnabled = False
ctx.drawImage(img, 0, 0)
global world
world = {{ gamegrid }}


def draw(arr):
    for y in range(len(arr)):
        for x in range(len(arr[y])):
            if arr[y][x] < 127:
                ctx.fillStyle = 'rgb(0,0,0)'
            else:
                ctx.fillStyle = 'rgb(255,255,255)'
            ctx.fillRect(x, y, 1, 1)
    return ctx

def play_step(world):
    stepped_world = world.copy()
    for y in range(len(world)):
        for x in range(len(world[y])):
        
            cell = world[y][x]
            neighbor_count = 0
            # Getting neighbors
            for yy in range(-1, 2):
                for xx in range(-1, 2):
                    if yy == 0 and xx == 0:
                        continue
                
                    y_cell = y+yy
                    x_cell = x+xx
                
                    if (y_cell >= 0 and x_cell >= 0) and (y_cell < len(world) and x_cell < len(world[y])):
                        neighbor = world[y + yy][x+ xx]
                        if neighbor < 127:
                            neighbor_count += 1

            # cell is alive 
            if cell < 127 and neighbor_count < 2:
                stepped_world[y][x] = 255
            elif cell < 127 and neighbor_count > 3:
                stepped_world[y][x] = 255
            # If cell is dead
            elif cell > 127 and neighbor_count == 3:
                stepped_world[y][x] = 0
    return stepped_world


document <= canvas

def update(i):
    global world
    stepped_world = play_step(world)
    draw(stepped_world)
    document <= canvas

document['next_button'].bind("click", update)

</script>


  </body>
</html>